generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  CHECKED_IN
  CANCELLED
  NO_SHOW
  COMPLETED
}

enum ReservationStatus {
  ACTIVE
  CONSUMED
  EXPIRED
  CANCELLED
}

enum EncounterStatus {
  OPEN
  CLOSED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  VIEW
  LOGIN
  EXPORT
}

enum TransactionType {
  CHARGE // Cobrança (débito na conta)
  PAYMENT // Pagamento (crédito na conta)
  REFUND // Estorno
  ADJUSTMENT // Ajuste manual
}

enum PaymentStatus {
  PENDING
  APPROVED
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentMethod {
  PIX
  CREDIT_CARD
  DEBIT_CARD
  CASH
  BOLETO
  TRANSFER
}


enum OrderStatus {
  CRIADO
  RASCUNHO
  AGUARDANDO_PAGAMENTO
  PAGO
  AGUARDANDO_COMPRA
  AGUARDANDO_CHEGADA
  AGUARDANDO_MATERIAL // Deprecated
  EM_SEPARACAO
  PRONTO_PARA_RETIRA
  PRONTO_PARA_ENTREGA // Deprecated
  SAIU_PARA_ENTREGA
  ENTREGUE
  CANCELADO
}


// Sales Module Enums
enum SaleType {
  UNIT
  AREA
  BOTH
}

enum CustomerType {
  PF // Pessoa Física
  PJ // Pessoa Jurídica
}

enum QuoteStatus {
  EM_ORCAMENTO
  AGUARDANDO_APROVACAO
  APROVADO
  REJEITADO
  EXPIRADO
  CONVERTIDO
}

enum ReservationType {
  ORCAMENTO
  PEDIDO
}

// Multi-tenant schema
// User model with authentication fields
model User {
  id                       String                     @id @default(uuid())
  email                    String                     @unique
  password                 String
  name                     String?
  isActive                 Boolean                    @default(true)
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  clinicUsers              ClinicUser[]
  appointments             Appointment[]              @relation("ProfessionalAppointments")
  encounters               Encounter[]                @relation("ProfessionalEncounters")
  auditLogs                AuditLog[]
  notesCreated             EncounterNote[]            @relation("NoteCreator")
  notesUpdated             EncounterNote[]            @relation("NoteUpdater")
  attachmentsUploaded      EncounterAttachment[]      @relation("AttachmentUploader")
  blockedSchedules         ScheduleBlock[]            @relation("BlockedProfessional")
  createdBlocks            ScheduleBlock[]            @relation("BlockCreator")
  notices                  Notice[]                   @relation("NoticeCreator")
  dashboardConfigs         UserDashboardConfig[]
  professionalWorkingHours ProfessionalWorkingHours[]

  // Sales Module Relations
  quotesAsSeller Quote[] @relation("QuoteSeller")
  ordersAsSeller Order[] @relation("OrderSeller")

  // Super Admin
  isSuperAdmin Boolean @default(false)
}

// Clinic model for multi-tenant support
model Clinic {
  id                       String                     @id @default(uuid())
  name                     String
  slug                     String                     @unique
  isActive                 Boolean                    @default(true)
  logoUrl                  String?                    // URL do logo da loja
  modules                  String[]                   @default([]) // Módulos ativos: SALES, FINANCE, STOCK, etc.
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  clinicUsers              ClinicUser[]
  patients                 Patient[]
  appointments             Appointment[]
  encounters               Encounter[]
  records                  RecordEntry[]
  procedures               ProcedurePerformed[]
  consumables              ConsumableUsage[]
  auditLogs                AuditLog[]
  products                 Product[]
  stockLots                StockLot[]
  stockMovements           StockMovement[]
  encounterNotes           EncounterNote[]
  encounterAttachments     EncounterAttachment[]
  scheduleBlocks           ScheduleBlock[]
  workingHours             ClinicWorkingHours[]
  notices                  Notice[]
  dashboardConfigs         UserDashboardConfig[]
  specialties              Specialty[]
  professionalWorkingHours ProfessionalWorkingHours[]
  procedureCatalog         Procedure[]
  patientAccounts          PatientAccount[]
  transactions             Transaction[]
  payments                 Payment[]
  stockEntries             StockEntry[]
  stockExits               StockExit[]

  // Sales Module Relations
  customers       Customer[]
  architects      Architect[]
  quotes          Quote[]
  orders          Order[]
  purchaseOrders  PurchaseOrder[]
  stockReservations StockReservation[]
  deliveries      Delivery[]
  invoices        Invoice[]
  expenses        Expense[]
  suppliers       Supplier[]
  quoteTemplates  QuoteTemplate[]
}

// Clinic working hours per day of week
model ClinicWorkingHours {
  id        String   @id @default(uuid())
  clinicId  String
  dayOfWeek Int // 0=Sunday, 1=Monday, ..., 6=Saturday
  isOpen    Boolean  @default(false)
  startTime String? // "HH:MM" format
  endTime   String? // "HH:MM" format
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  clinic    Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@unique([clinicId, dayOfWeek])
}

// Pivot table for User-Clinic many-to-many relationship with role
model ClinicUser {
  id          String   @id @default(uuid())
  clinicId    String
  userId      String
  roleId      String
  specialtyId String?
  color       String? // Hex color for calendar (#FF5733)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  clinic    Clinic     @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  role      Role       @relation(fields: [roleId], references: [id])
  specialty Specialty? @relation(fields: [specialtyId], references: [id])

  @@unique([clinicId, userId])
  @@index([userId])
  @@index([clinicId])
  @@index([roleId])
  @@index([specialtyId])
}

// RBAC: Role model
model Role {
  id              String           @id @default(uuid())
  key             String           @unique
  name            String
  description     String?
  createdAt       DateTime         @default(now())
  clinicUsers     ClinicUser[]
  rolePermissions RolePermission[]
}

// RBAC: Permission model
model Permission {
  id              String           @id @default(uuid())
  key             String           @unique
  description     String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rolePermissions RolePermission[]
}

// RBAC: Role-Permission pivot table
model RolePermission {
  roleId       String
  permissionId String

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

// Business: Patient model
model Patient {
  id        String    @id @default(uuid())
  clinicId  String
  name      String
  email     String?
  phone     String?
  document  String?
  birthDate DateTime?
  gender    String?
  notes     String?
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  clinic       Clinic          @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  appointments Appointment[]
  encounters   Encounter[]
  account      PatientAccount?
  transactions Transaction[]
  payments     Payment[]

  @@index([clinicId])
  @@index([clinicId, name])
  @@index([clinicId, document])
}

// Business: Appointment model
model Appointment {
  id             String            @id @default(uuid())
  clinicId       String
  patientId      String
  professionalId String
  startAt        DateTime
  endAt          DateTime
  status         AppointmentStatus @default(SCHEDULED)
  room           String?
  notes          String?
  checkedInAt    DateTime?
  cancelledAt    DateTime?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  clinic       Clinic      @relation(fields: [clinicId], references: [id])
  patient      Patient     @relation(fields: [patientId], references: [id])
  professional User        @relation("ProfessionalAppointments", fields: [professionalId], references: [id])
  encounters   Encounter[] // Relation to encounters

  @@index([clinicId])
  @@index([startAt])
  @@index([patientId])
  @@index([professionalId])
}

// Business: Encounter model (Atendimento)
model Encounter {
  id             String          @id @default(uuid())
  clinicId       String
  patientId      String
  professionalId String
  appointmentId  String? // Optional link to appointment
  date           String // Date in YYYY-MM-DD format
  time           String? // Time in HH:MM format (optional)
  notes          String? // General notes about the encounter
  status         EncounterStatus @default(OPEN)
  openedAt       DateTime        @default(now())
  closedAt       DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  clinic         Clinic                @relation(fields: [clinicId], references: [id])
  patient        Patient               @relation(fields: [patientId], references: [id])
  professional   User                  @relation("ProfessionalEncounters", fields: [professionalId], references: [id])
  appointment    Appointment?          @relation(fields: [appointmentId], references: [id])
  records        RecordEntry[]
  procedures     ProcedurePerformed[]
  consumables    ConsumableUsage[]
  note           EncounterNote?
  attachments    EncounterAttachment[]
  transactions   Transaction[]
  stockMovements StockMovement[]

  @@index([clinicId])
  @@index([appointmentId])
}

// Business: RecordEntry model (Entrada de Prontuário)
model RecordEntry {
  id          String   @id @default(uuid())
  clinicId    String
  encounterId String
  type        String
  content     Json
  isLocked    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  clinic    Clinic    @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  encounter Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([encounterId])
}

// Business: ProcedurePerformed model (Procedimentos realizados)
model ProcedurePerformed {
  id          String   @id @default(uuid())
  clinicId    String
  encounterId String
  procedureId String? // Link ao catálogo de procedimentos
  name        String
  priceCents  Int?
  notes       String?
  isActive    Boolean  @default(true)
  performedAt DateTime @default(now())
  createdAt   DateTime @default(now())

  clinic    Clinic     @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  encounter Encounter  @relation(fields: [encounterId], references: [id], onDelete: Cascade)
  procedure Procedure? @relation(fields: [procedureId], references: [id], onDelete: SetNull)

  @@index([clinicId])
  @@index([encounterId])
  @@index([procedureId])
}

// Business: ConsumableUsage model (Consumíveis utilizados)
model ConsumableUsage {
  id          String   @id @default(uuid())
  clinicId    String
  encounterId String
  itemName    String
  quantity    Float    @default(1)
  unit        String?
  notes       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  clinic    Clinic    @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  encounter Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)
  product   Product?  @relation(fields: [productId], references: [id], onDelete: SetNull)

  productId String?

  @@index([clinicId])
  @@index([encounterId])
}

// System: AuditLog model (Auditoria de ações)
model AuditLog {
  id        String      @id @default(uuid())
  clinicId  String?
  userId    String?
  action    AuditAction
  entity    String
  entityId  String?
  message   String?
  ip        String?
  userAgent String?
  details   Json?
  createdAt DateTime    @default(now())

  clinic Clinic? @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([clinicId, createdAt])
  @@index([userId, createdAt])
}

enum StockMovementType {
  IN
  OUT
  ADJUST
}

// Business: Product model (Produtos para estoque)
model Product {
  id          String   @id @default(uuid())
  clinicId    String
  name        String
  description String?
  unit        String? // e.g., "unidade", "caixa", "ml"
  sku         String?
  barcode     String?
  minStock    Float    @default(0)
  costCents   Int? // Custo de aquisição em centavos
  priceCents  Int? // Preço de venda em centavos
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Campos Dimensionais para Revestimentos
  saleType     SaleType @default(UNIT) // Tipo de venda: unidade, área ou ambos
  boxCoverage  Float? // m² cobertos por caixa (ex: 1.44)
  piecesPerBox Int? // peças por caixa (ex: 8)
  boxWeight    Float? // peso da caixa em kg
  palletBoxes  Int? // caixas por palete
  palletWeight Float? // peso do palete em kg
  palletCoverage Float? // m² cobertos por palete

  // Campos de Padronização e Importação (Phase 7)
  supplierId    String? 
  supplier      Supplier? @relation(fields: [supplierId], references: [id])
  
  format        String? // ex: "60x60", "30x90"
  usage         String? // ex: "Piso", "Parede", "Externo"
  line          String? // ex: "Mármore", "Concreto", "Madeira"
  supplierCode  String? // Código de referência do fornecedor (Ref.)

  clinic               Clinic                @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  lots                 StockLot[]
  movements            StockMovement[]
  procedureConsumables ProcedureConsumable[]
  consumableUsages     ConsumableUsage[]
  stockEntryItems      StockEntryItem[]
  stockExitItems       StockExitItem[]
  quoteItems           QuoteItem[]
  orderItems           OrderItem[]
  purchaseOrderItems   PurchaseOrderItem[]
  stockReservations    StockReservation[]

  @@index([supplierId])
  @@index([clinicId])
  @@index([clinicId, isActive])
}

// Business: StockLot model (Lotes de estoque com validade)
model StockLot {
  id             String   @id @default(uuid())
  clinicId       String
  productId      String
  lotNumber      String
  quantity       Float
  expirationDate DateTime
  createdAt      DateTime @default(now())
  updatedAt      DateTime @default(now()) @updatedAt

  // Campos para Revestimentos (Tonalidade e Calibre)
  shade   String? // Tonalidade (ex: "A1", "B2")
  caliber String? // Calibre (ex: "9mm", "10mm")

  clinic         Clinic          @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  product        Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  movements      StockMovement[]
  stockExitItems StockExitItem[]
  quoteItems     QuoteItem[]
  orderItems     OrderItem[]
  reservations   StockReservation[]

  @@unique([clinicId, lotNumber])
  @@index([clinicId])
  @@index([productId])
  @@index([expirationDate])
  @@index([clinicId, productId])
}

// Business: StockReservation model (Reserva de Estoque)
model StockReservation {
  id        String   @id @default(uuid())
  clinicId  String
  
  orderId   String?
  orderItemId String?
  quoteId   String?
  lotId     String
  productId String?
  
  type      ReservationType @default(ORCAMENTO)
  quantity  Int
  status    ReservationStatus @default(ACTIVE)
  expiresAt DateTime
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  clinic    Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  order     Order?   @relation(fields: [orderId], references: [id])
  orderItem OrderItem? @relation(fields: [orderItemId], references: [id])
  quote     Quote?   @relation(fields: [quoteId], references: [id])
  
  quoteItemId String?
  quoteItem   QuoteItem? @relation(fields: [quoteItemId], references: [id])

  lot       StockLot @relation(fields: [lotId], references: [id])
  product   Product?  @relation(fields: [productId], references: [id])
  
  @@index([clinicId])
  @@index([orderId])
  @@index([orderItemId])
  @@index([quoteId])
  @@index([lotId])
  @@index([productId])
}

// Business: StockMovement model (Movimentações de estoque)
model StockMovement {
  id        String            @id @default(uuid())
  clinicId  String
  productId String
  lotId     String?
  type      StockMovementType
  quantity  Float
  reason    String?
  createdAt DateTime          @default(now())

  clinic  Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  product Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  lot     StockLot? @relation(fields: [lotId], references: [id], onDelete: SetNull)

  // Retail Context Links (NEW)
  orderId          String? // Link to Sales Order
  purchaseOrderId  String? // Link to Purchase Order
  stockEntryId     String? // Link to Stock Entry document
  stockExitId      String? // Link to Stock Exit document

  // Legacy Clinical Link (DEPRECATED - Keep for backward compatibility)
  encounterId     String? // Link to patient encounter
  encounter       Encounter? @relation(fields: [encounterId], references: [id], onDelete: SetNull)

  // Metadata fields
  invoiceNumber   String? // Nota Fiscal
  supplier        String? // Fornecedor
  batchId         String? // Group items from same operation
  destinationType String? // 'CUSTOMER', 'SHOWROOM', 'DAMAGE', 'RETURN', 'ADJUST'
  destinationName String? // e.g. "Cliente X", "Showroom Principal"

  @@index([clinicId])
  @@index([productId])
  @@index([clinicId, createdAt])
  @@index([encounterId])
  @@index([orderId])
  @@index([purchaseOrderId])
  @@index([stockEntryId])
  @@index([stockExitId])
}

// Business: StockEntry (Entrada de Nota/Estoque)
model StockEntry {
  id       String      @id @default(uuid())
  clinicId String
  status   EntryStatus @default(DRAFT)
  type     EntryType   @default(INVOICE) // INVOICE, MANUAL, DONATION

  invoiceNumber String?
  series        String?
  supplierId    String?
  supplierName  String? // Denormalized name or free text if no Supplier model yet

  purchaseOrderId String?
  purchaseOrder   PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])

  // --- Fiscal Identifiers ---
  accessKey       String?   @unique // Chave de acesso 44 dígitos
  operationNature String?   // Natureza da Operação
  protocol        String?   // Protocolo de Autorização
  model           String?   @default("55") // Modelo (55=NF-e)

  // --- Fiscal Totals (All in Cents) ---
  calculationBaseICMS     Int? @default(0)
  valueICMS               Int? @default(0)
  calculationBaseICMSST   Int? @default(0)
  valueICMSST             Int? @default(0)
  totalProductsValueCents Int? @default(0) // Valor total dos produtos (sem impostos/add)
  freightValueCents       Int? @default(0) // Valor do Frete
  insuranceValueCents     Int? @default(0) // Valor do Seguro
  discountValueCents      Int? @default(0) // Valor do Desconto
  otherExpensesValueCents Int? @default(0) // Outras Despesas Acessórias
  totalIPIValueCents      Int? @default(0) // Valor Total do IPI

  // --- Transport / Logistics ---
  freightType     Int?    // 0=Remetente(CIF), 1=Destinatário(FOB), 9=Sem Frete
  carrierName     String? // Nome do Transportador
  carrierDocument String? // CPF/CNPJ do Transportador
  carrierPlate    String? // Placa do Veículo
  carrierState    String? // UF do Veículo
  
  // --- Volumes ---
  volumeQuantity  Int?    // Quantidade de volumes
  volumeSpecies   String? // Espécie (Caixas, Paletes)
  grossWeight     Float?  // Peso Bruto (kg)
  netWeight       Float?  // Peso Líquido (kg)

  emissionDate DateTime?
  arrivalDate  DateTime  @default(now())

  totalValue Float? // Sum of items (Legacy - consider deprecating or syncing with totalNoteValue)
  notes      String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  confirmedAt DateTime?
  confirmedBy String? // User ID

  clinic Clinic           @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  items  StockEntryItem[]

  @@index([clinicId])
  @@index([status])
}

model StockEntryItem {
  id           String @id @default(uuid())
  stockEntryId String
  productId    String

  quantity  Float
  unitCost  Float? // Cost per unit (legacy float)
  totalCost Float? // quantity * unitCost (legacy float)

  // --- Fiscal Classification ---
  ncm     String? // Nomenclatura Comum do Mercosul
  cfop    String? // Código Fiscal de Operações e Prestações (e.g. 5102, 1102)
  cst     String? // Código de Situação Tributária
  
  // --- Item Values ---
  discountValueCents Int? @default(0)
  freightValueCents  Int? @default(0)
  insuranceValueCents Int? @default(0)
  
  // --- Tax Values per Item ---
  valueICMS     Int? @default(0)
  rateICMS      Float? @default(0)
  valueIPI      Int? @default(0)
  rateIPI       Float? @default(0)

  lotNumber      String?
  expirationDate DateTime?
  manufacturer   String?

  stockEntry StockEntry @relation(fields: [stockEntryId], references: [id], onDelete: Cascade)
  product    Product    @relation(fields: [productId], references: [id])

  @@index([stockEntryId])
  @@index([productId])
}

// Business: StockExit (Saída/Requisição)
model StockExit {
  id       String     @id @default(uuid())
  clinicId String
  status   ExitStatus @default(DRAFT)
  type     ExitType   @default(SECTOR_REQUEST) // SECTOR, PATIENT, DISCARD, EXPIRY

  destinationType String? // SECTOR, ROOM, PATIENT
  destinationName String? // Name or ID
  encounterId     String? // If linked to patient encounter

  requestedBy String? // User ID or Name
  approvedBy  String? // User ID

  notes String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  confirmedAt DateTime?

  clinic Clinic          @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  items  StockExitItem[]

  @@index([clinicId])
  @@index([status])
}

model StockExitItem {
  id          String @id @default(uuid())
  stockExitId String
  productId   String

  quantity Float
  lotId    String? // Should ideally be selected at confirmation or via FIFO

  stockExit StockExit @relation(fields: [stockExitId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id])
  lot       StockLot? @relation(fields: [lotId], references: [id])

  @@index([stockExitId])
  @@index([productId])
}

enum EntryStatus {
  DRAFT
  CONFIRMED
  CANCELED
}

enum EntryType {
  INVOICE
  MANUAL
  DONATION
  RETURN
}

enum ExitStatus {
  DRAFT
  APPROVED
  REJECTED
  CONFIRMED
}

enum ExitType {
  SECTOR_REQUEST
  PATIENT_USE
  DISCARD
  EXPIRY
  ADJUSTMENT
  SALE
}

// Business: EncounterNote model (SOAP Clinical Notes)
model EncounterNote {
  id          String   @id @default(uuid())
  encounterId String   @unique
  clinicId    String
  subjective  String?  @db.Text
  objective   String?  @db.Text
  assessment  String?  @db.Text
  plan        String?  @db.Text
  createdById String
  updatedById String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  encounter Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)
  clinic    Clinic    @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  createdBy User      @relation("NoteCreator", fields: [createdById], references: [id])
  updatedBy User?     @relation("NoteUpdater", fields: [updatedById], references: [id])

  @@index([clinicId])
  @@index([encounterId])
}

// Business: EncounterAttachment model (Clinical Files)
model EncounterAttachment {
  id           String   @id @default(uuid())
  clinicId     String
  encounterId  String
  filename     String // UUID-based unique filename
  originalName String // Original uploaded filename
  mimeType     String
  size         Int // Bytes
  storagePath  String // /uploads/clinics/{clinicId}/encounters/{encounterId}/{filename}
  uploadedById String
  createdAt    DateTime @default(now())

  clinic     Clinic    @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  encounter  Encounter @relation(fields: [encounterId], references: [id], onDelete: Cascade)
  uploadedBy User      @relation("AttachmentUploader", fields: [uploadedById], references: [id])

  @@index([clinicId])
  @@index([encounterId])
}

// Business: ScheduleBlock model (Calendar Blockers)
model ScheduleBlock {
  id             String   @id @default(uuid())
  clinicId       String
  professionalId String? // null = clinic-wide block
  date           String // YYYY-MM-DD
  startTime      String? // HH:MM (null = full day)
  endTime        String? // HH:MM (null = full day)
  reason         String?
  isActive       Boolean  @default(true)
  createdById    String
  createdAt      DateTime @default(now())

  clinic       Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  professional User?  @relation("BlockedProfessional", fields: [professionalId], references: [id])
  createdBy    User   @relation("BlockCreator", fields: [createdById], references: [id])

  @@index([clinicId, date])
  @@index([professionalId])
}

// Business: Notice model (Clinic announcements)
model Notice {
  id          String    @id @default(uuid())
  clinicId    String
  title       String
  content     String?
  priority    String    @default("normal") // low, normal, high, urgent
  isActive    Boolean   @default(true)
  expiresAt   DateTime?
  createdById String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  clinic    Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  createdBy User   @relation("NoticeCreator", fields: [createdById], references: [id])

  @@index([clinicId, isActive])
  @@index([clinicId, expiresAt])
}

// User: Dashboard widget configuration per user per clinic
model UserDashboardConfig {
  id        String   @id @default(uuid())
  userId    String
  clinicId  String
  widgets   Json // Array of widget types: ["birthdays", "today_appointments", ...]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  clinic Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@unique([userId, clinicId])
  @@index([userId])
}

// Business: Specialty model (Professional specialties)
model Specialty {
  id        String   @id @default(uuid())
  clinicId  String
  name      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinic      Clinic       @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  clinicUsers ClinicUser[]

  @@unique([clinicId, name])
  @@index([clinicId])
}

// Business: Professional working hours per day of week
model ProfessionalWorkingHours {
  id        String   @id @default(uuid())
  clinicId  String
  userId    String
  dayOfWeek Int // 0=Sunday, 1=Monday, ..., 6=Saturday
  isOpen    Boolean  @default(true)
  startTime String? // "HH:MM" format
  endTime   String? // "HH:MM" format
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinic Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([clinicId, userId, dayOfWeek])
  @@index([clinicId])
  @@index([userId])
}

// Business: Procedure Catalog (Catálogo de procedimentos com precificação)
model Procedure {
  id          String   @id @default(uuid())
  clinicId    String
  name        String
  description String?
  priceCents  Int // Preço cobrado em centavos
  durationMin Int? // Duração padrão em minutos
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  clinic      Clinic                @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  consumables ProcedureConsumable[]
  performed   ProcedurePerformed[]

  @@index([clinicId])
  @@index([clinicId, isActive])
}

// Business: ProcedureConsumable (Insumos padrão por procedimento)
model ProcedureConsumable {
  id          String   @id @default(uuid())
  procedureId String
  productId   String
  quantity    Float    @default(1)
  createdAt   DateTime @default(now())

  procedure Procedure @relation(fields: [procedureId], references: [id], onDelete: Cascade)
  product   Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([procedureId, productId])
  @@index([procedureId])
  @@index([productId])
}

// Finance: PatientAccount (Conta corrente do paciente)
model PatientAccount {
  id           String   @id @default(uuid())
  clinicId     String
  patientId    String?  @unique
  balanceCents Int      @default(0) // Negativo = deve, Positivo = crédito
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  clinic       Clinic        @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  patient      Patient?      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  customerId   String?       @unique
  customer     Customer?     @relation(fields: [customerId], references: [id], onDelete: Cascade)

  transactions Transaction[]

  @@index([clinicId])
  @@index([patientId])
  @@index([customerId])
}

// Finance: Transaction (Transações financeiras)
model Transaction {
  id          String          @id @default(uuid())
  clinicId    String
  patientId   String?
  customerId  String?
  accountId   String
  encounterId String? // Referência ao atendimento (se cobrança)
  paymentId   String? // Referência ao pagamento (se pagamento)
  type        TransactionType
  amountCents Int // Sempre positivo
  description String?
  createdAt   DateTime        @default(now())

  clinic    Clinic         @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  patient   Patient?       @relation(fields: [patientId], references: [id], onDelete: Cascade)
  customer  Customer?      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  account   PatientAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  encounter Encounter?     @relation(fields: [encounterId], references: [id], onDelete: SetNull)
  payment   Payment?       @relation(fields: [paymentId], references: [id], onDelete: SetNull)

  @@index([clinicId])
  @@index([patientId])
  @@index([customerId])
  @@index([accountId])
  @@index([encounterId])
  @@index([paymentId])
  @@index([clinicId, createdAt])
}

// Finance: Payment (Pagamentos recebidos)
model Payment {
  id           String        @id @default(uuid())
  clinicId     String
  patientId    String?
  customerId   String?
  amountCents  Int
  method       PaymentMethod
  status       PaymentStatus @default(PENDING)
  installments Int           @default(1)
  externalId   String? // ID do gateway
  gatewayData  Json? // Dados do gateway
  paidAt       DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  clinic       Clinic        @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  patient      Patient?      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  customer     Customer?     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  transactions Transaction[]

  @@index([clinicId])
  @@index([patientId])
  @@index([customerId])
  @@index([clinicId, createdAt])
  @@index([status])
}

// =====================================================
// SALES MODULE - Módulo de Vendas para Revestimentos
// =====================================================

// Business: Customer model (Cliente - substitui Patient para vendas)
model Customer {
  id       String       @id @default(uuid())
  clinicId String // Tenant (loja)
  type     CustomerType @default(PF)

  // Dados básicos
  name              String
  email             String?
  phone             String?
  document          String? // CPF ou CNPJ
  stateRegistration String? // Inscrição Estadual (para PJ)
  birthDate         DateTime? // Data de Nascimento/Fundação

  // Endereço
  address       String?
  addressNumber String?
  complement    String?
  neighborhood  String?
  city          String?
  state         String?
  zipCode       String?

  // Relacionamentos
  architectId String? // Arquiteto que indicou
  architect   Architect? @relation(fields: [architectId], references: [id])

  // Financeiro
  creditLimitCents Int? // Limite de crédito em centavos

  notes     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinic Clinic  @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  quotes Quote[]
  orders Order[]
  
  // Finance
  patientAccount PatientAccount?
  transactions   Transaction[]
  payments       Payment[]

  @@index([clinicId])
  @@index([clinicId, name])
  @@index([clinicId, document])
  @@index([architectId])
}

// Business: Architect model (Arquiteto/Indicador parceiro)
model Architect {
  id             String   @id @default(uuid())
  clinicId       String
  name           String
  email          String?
  phone          String?
  document       String? // CPF
  birthDate      DateTime?
  commissionRate Float? // Percentual de comissão (ex: 3.0 = 3%)
  notes          String?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  clinic    Clinic     @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  customers Customer[]
  quotes    Quote[]

  @@index([clinicId])
  @@index([clinicId, name])
}

// Business: QuoteTemplate model (Template de Orçamento)
model QuoteTemplate {
  id        String  @id @default(uuid())
  clinicId  String
  name      String  // Nome do template (ex: "Padrão", "Promocional")
  isDefault Boolean @default(false)

  // Dados da Empresa (Header)
  companyName    String?
  companyLogo    String? // URL ou base64 da logo
  companyPhone   String?
  companyEmail   String?
  companyAddress String?
  companyCnpj    String?

  // Dados Bancários
  bankName          String?
  bankAgency        String?
  bankAccount       String?
  bankAccountHolder String?
  bankCnpj          String?
  pixKey            String?

  // Termos e Condições
  termsAndConditions String? @db.Text
  validityDays       Int     @default(10)
  validityText       String? // Ex: "Este orçamento possui validade de 10 dias úteis..."

  // Prazo de entrega padrão
  defaultDeliveryDays String? // Ex: "7dd", "15 dias úteis"

  // Personalização Visual
  primaryColor       String @default("#000000")
  accentColor        String @default("#4CAF50")
  showSignatureLines Boolean @default(true)
  showBankDetails    Boolean @default(true)
  showTerms          Boolean @default(true)

  // Rodapé
  footerText String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinic Clinic @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@index([clinicId])
}

// Business: Quote model (Orçamento)
model Quote {
  id       String @id @default(uuid())
  clinicId String
  number   Int // Número sequencial do orçamento

  // Relacionamentos
  customerId  String
  customer    Customer   @relation(fields: [customerId], references: [id])
  architectId String?
  architect   Architect? @relation(fields: [architectId], references: [id])
  sellerId    String // Usuário que criou
  seller      User       @relation("QuoteSeller", fields: [sellerId], references: [id])

  // Status e datas
  status     QuoteStatus @default(EM_ORCAMENTO)
  validUntil DateTime? // Data de validade
  sentAt     DateTime?
  approvedAt DateTime?

  // Valores
  subtotalCents   Int    @default(0)
  discountCents   Int    @default(0) // Desconto total em centavos
  discountPercent Float? // OU desconto em %
  deliveryFee     Int    @default(0) // Taxa de entrega em centavos
  totalCents      Int    @default(0)

  notes         String? // Observações (vão no PDF)
  internalNotes String? // Notas internas (não vão no PDF)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinic Clinic      @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  items  QuoteItem[]
  order  Order? // Pedido gerado (se convertido)
  stockReservations StockReservation[]

  @@unique([clinicId, number])
  @@index([clinicId])
  @@index([clinicId, status])
  @@index([customerId])
  @@index([sellerId])
}

// Business: QuoteItem model (Item do Orçamento)
model QuoteItem {
  id        String @id @default(uuid())
  quoteId   String
  productId String

  // Quantidades (lógica dimensional)
  inputArea     Float? // Área informada pelo usuário (m²)
  quantityBoxes Int // Quantidade de caixas (calculada ou manual)
  resultingArea Float? // Área real (caixas * boxCoverage)

  // Preços
  unitPriceCents  Int // Preço por m² ou por caixa
  discountCents   Int    @default(0)
  discountPercent Float?
  totalCents      Int

  // Lote preferido (opcional)
  preferredLotId String?
  preferredLot   StockLot? @relation(fields: [preferredLotId], references: [id])

  notes String? // Ex: "Aplicar na área da cozinha"

  createdAt DateTime @default(now())

  quote   Quote   @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])
  reservations StockReservation[]

  @@index([quoteId])
  @@index([productId])
}

enum FulfillmentStatus {
  PENDING             // Aguardando processamento
  AWAITING_STOCK      // Aguardando chegada de material (Backorder/Cross-docking)
  AWAITING_PICKING    // Estoque disponível, aguardando separação
  IN_PICKING          // Em separação
  READY_FOR_PICKUP    // Separado e aguardando retirada
  OUT_FOR_DELIVERY    // Saiu para entrega
  DELIVERED           // Entregue ao cliente
  RETURNED            // Devolvido
  PARTIALLY_FULFILLED // Parcialmente atendido
}

// Business: Order model (Pedido de Venda)
model Order {
  id       String @id @default(uuid())
  clinicId String
  number   Int // Número sequencial do pedido

  // Origem
  quoteId String? @unique
  quote   Quote?  @relation(fields: [quoteId], references: [id])

  // Relacionamentos
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])
  sellerId   String
  seller     User     @relation("OrderSeller", fields: [sellerId], references: [id])

  status OrderStatus @default(CRIADO)

  // Valores (copiados do Quote ou recalculados)
  subtotalCents Int
  discountCents Int @default(0)
  deliveryFee   Int @default(0)
  totalCents    Int

  // Status Logístico (Novo)
  fulfillmentStatus FulfillmentStatus @default(PENDING)

  // Entrega
  deliveryAddress String?
  deliveryDate    DateTime?
  deliveredAt     DateTime?
  
  delivery        Delivery?

  notes String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  confirmedAt DateTime?

  clinic         Clinic          @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  items          OrderItem[]
  invoices       Invoice[]
  purchaseOrders PurchaseOrder[]
  stockReservations StockReservation[]

  @@unique([clinicId, number])
  @@index([clinicId])
  @@index([clinicId, status])
  @@index([customerId])
  @@index([sellerId])
}

// Business: OrderItem model (Item do Pedido)
model OrderItem {
  id        String @id @default(uuid())
  orderId   String
  productId String

  // Quantidades (copiadas do QuoteItem ou inseridas manualmente)
  inputArea     Float? // Área original (m²)
  quantityBoxes Int // Quantidade de caixas
  resultingArea Float? // Área real (caixas * boxCoverage)

  // Preços
  unitPriceCents Int
  discountCents  Int @default(0)
  totalCents     Int

  // Lote reservado/usado
  lotId String?

  status String? // Para controle de entrega parcial (ENTREGUE, PENDENTE, etc)

  notes String?

  createdAt DateTime @default(now())

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])
  lot     StockLot? @relation(fields: [lotId], references: [id])
  reservations StockReservation[]

  @@index([orderId])
  @@index([productId])
}

// =====================================================
// PURCHASE MODULE - Módulo de Compras
// =====================================================

enum PurchaseOrderStatus {
  DRAFT // Rascunho
  SENT // Enviado ao fornecedor
  CONFIRMED // Confirmado pelo fornecedor
  PARTIAL // Recebido parcialmente
  RECEIVED // Recebido totalmente
  CANCELLED // Cancelado
}

// Business: Supplier model (Fornecedor)
model Supplier {
  id        String   @id @default(uuid())
  clinicId  String
  name      String
  cnpj      String?
  email     String?
  phone     String?
  address   String?
  city      String?
  state     String?
  notes     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinic         Clinic          @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  purchaseOrders PurchaseOrder[]
  products       Product[]

  @@unique([clinicId, cnpj])
  @@index([clinicId])
}

// Business: PurchaseOrder model (Pedido de Compra)
model PurchaseOrder {
  id       String @id @default(uuid())
  clinicId String
  number   Int // Número sequencial

  // Fornecedor
  supplierId    String?
  supplierName  String   // Mantido para compatibilidade/histórico
  supplierCnpj  String?
  supplierEmail String?
  supplierPhone String?

  // Vinculo com Pedido de Venda (se for compra para atender venda)
  salesOrderId String?

  status PurchaseOrderStatus @default(DRAFT)

  // Valores
  subtotalCents Int @default(0)
  shippingCents Int @default(0)
  totalCents    Int @default(0)

  // Datas
  expectedDate DateTime? // Data prevista de entrega
  receivedAt   DateTime?
  
  // NFe relacionada
  nfeNumber String?
  nfeKey    String? // Chave de acesso da NFe

  notes String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  clinic     Clinic              @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  supplier   Supplier?           @relation(fields: [supplierId], references: [id])
  salesOrder Order?              @relation(fields: [salesOrderId], references: [id])
  stockEntries StockEntry[]
  items      PurchaseOrderItem[]
  expenses   Expense[]

  @@unique([clinicId, number])
  @@index([clinicId])
  @@index([supplierId])
}

// ... (Rest of file) ...

enum ExpenseType {
  SUPPLIER
  OPERATIONAL
  TAX
  COMMISSION
  OTHER
}

enum ExpenseStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

model Expense {
  id              String        @id @default(uuid())
  clinicId        String
  
  description     String
  amountCents     Int
  dueDate         DateTime
  paidAt          DateTime?
  
  status          ExpenseStatus @default(PENDING)
  type            ExpenseType   @default(OPERATIONAL)
  
  // Optional Links
  purchaseOrderId String?
  purchaseOrder   PurchaseOrder? @relation(fields: [purchaseOrderId], references: [id])
  
  // Boleto Data
  barCode         String?
  recipientName   String?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  clinic          Clinic        @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  
  @@index([clinicId])
  @@index([clinicId, status])
  @@index([clinicId, dueDate])
}

// Business: PurchaseOrderItem model (Item do Pedido de Compra)
model PurchaseOrderItem {
  id              String @id @default(uuid())
  purchaseOrderId String
  productId       String?

  // Dados do produto (podem não existir no sistema ainda)
  productCode  String
  productName  String
  quantityOrdered Int
  quantityReceived Int @default(0)
  unitPriceCents  Int
  totalCents      Int

  // Lote criado ao receber
  lotId String?

  createdAt DateTime @default(now())

  purchaseOrder PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  product       Product?      @relation(fields: [productId], references: [id])

  @@index([purchaseOrderId])
  @@index([productId])
}

// =====================================================
// DELIVERY MODULE - Módulo de Entregas
// =====================================================

enum DeliveryStatus {
  PENDING     // Pendente de agendamento
  SCHEDULED   // Agendado
  IN_TRANSIT  // Em trânsito
  DELIVERED   // Entregue
  FAILED      // Tentativa falhou
  CANCELED    // Cancelado
}

enum InvoiceStatus {
  PENDING
  PAID
  OVERDUE
  CANCELLED
}

model Delivery {
  id        String   @id @default(uuid())
  clinicId  String
  
  orderId   String   @unique
  order     Order    @relation(fields: [orderId], references: [id])
  
  status        DeliveryStatus @default(PENDING)
  scheduledDate DateTime?
  
  driverName    String?
  vehiclePlate  String?
  trackingCode  String?
  
  notes         String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  clinic        Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)
  
  @@index([clinicId])
  @@index([orderId])
  @@index([status])
}

// Payment: Invoice model (Boletos)
model Invoice {
  id              String   @id @default(uuid())
  clinicId        String
  
  orderId         String
  order           Order    @relation(fields: [orderId], references: [id])
  
  // Boleto Data
  amountCents     Int
  dueDate         DateTime
  status          InvoiceStatus @default(PENDING) 
  
  // External Provider (Future Integration)
  provider        String?  // 'ASAAS', 'IUGU', etc.
  externalId      String?  // ID in the provider
  pdfUrl          String?  // URL to download PDF
  barCode         String?  // Linha digitável
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  paidAt          DateTime?

  clinic          Clinic   @relation(fields: [clinicId], references: [id], onDelete: Cascade)

  @@index([clinicId])
  @@index([orderId])
}
